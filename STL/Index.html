<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <link rel="icon" href="https://mediaaccesscompany.com/wp-content/uploads/2022/12/logo_banner_home.png" type="image/png">
  <title><?= getTranslation('app_title', language) ?></title>
  <style>
    :root {
      --primary-color: #40c4c7; /* Turquesa de Media Access Co. */
      --secondary-color: #d34fc2; /* Magenta de Media Access Co. */
      --accent-color: #000000; /* Negro para acentos */
      --background-color: #f5f5f5; /* Gris claro para el fondo */
      --text-color: #2c3e50; /* Color oscuro para texto */
    }
    
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: var(--background-color);
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      background-color: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    h1 {
      color: var(--primary-color);
      text-align: center;
      margin-bottom: 30px;
    }
    
    .upload-section {
      border: 2px dashed var(--primary-color);
      padding: 30px;
      text-align: center;
      margin-bottom: 20px;
      border-radius: 4px;
      transition: all 0.3s;
    }
    
    .upload-section:hover, .drag-over {
      border-color: var(--secondary-color);
      background-color: rgba(211, 79, 194, 0.05); /* Fondo suave de magenta */
    }
    
    .file-input {
      display: none;
    }
    
    .upload-btn {
      background-color: var(--primary-color);
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s;
    }
    
    .upload-btn:hover {
      background-color: var(--secondary-color);
    }
    
    .progress-container {
      display: none;
      margin: 20px 0;
    }
    
    .progress-bar {
      height: 10px;
      background-color: #e0e0e0;
      border-radius: 5px;
      margin-top: 10px;
      overflow: hidden;
    }
    
    .progress {
      height: 100%;
      background-color: var(--primary-color);
      width: 0%;
      transition: width 0.3s;
    }
    
    .status {
      margin-top: 20px;
      padding: 10px;
      border-radius: 4px;
      display: none;
    }
    
    .success {
      background-color: #dff0d8;
      color: #3c763d;
    }
    
    .error {
      background-color: #f2dede;
      color: #a94442;
    }
    
    .instructions {
      background-color: rgba(64, 196, 199, 0.1); /* Fondo suave de turquesa */
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
    }
    
    .instructions h3 {
      margin-top: 0;
      color: var(--primary-color);
    }
    
    .instructions ul {
      margin-bottom: 0;
    }
    
    .download-btn {
      background-color: var(--secondary-color);
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s;
      display: none;
      margin-top: 20px;
    }
    
    .download-btn:hover {
      background-color: var(--primary-color);
    }
    
    /* Estilos para el botón de limpieza */
    .cleanup-btn {
      background-color: #f0ad4e; /* Color naranja/ámbar para limpieza */
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s;
      margin-top: 10px;
    }
    
    .cleanup-btn:hover {
      background-color: #ec971f;
    }
    
    .format-info {
      margin-top: 30px;
      font-size: 14px;
      color: #666;
    }
    
    .help-link {
      text-align: center;
      margin-top: 20px;
    }
    
    .help-link a {
      color: var(--secondary-color);
      text-decoration: none;
    }
    
    .help-link a:hover {
      text-decoration: underline;
      color: var(--primary-color);
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .version-info {
      font-size: 12px;
      color: #999;
    }
    
    .footer {
      margin-top: 40px;
      text-align: center;
      font-size: 12px;
      color: #666;
      border-top: 1px solid rgba(64, 196, 199, 0.3);
      padding-top: 15px;
    }
    
    .footer-content {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .footer-logo {
      margin-bottom: 10px;
      width: 120px;
      height: auto;
      object-fit: contain;
      display: block;
      margin: 0 auto;
    }
    
    .footer p {
      margin: 5px 0;
    }
    
    .footer a {
      color: var(--secondary-color);
      text-decoration: none;
    }
    
    .footer a:hover {
      color: var(--primary-color);
    }
    
    .logo {
      text-align: center;
      margin-bottom: 20px;
    }
    
    .logo img {
      max-width: 200px;
      height: auto;
      object-fit: contain;
      display: block;
      margin: 0 auto;
    }
    
    .language-selector {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      gap: 5px;
    }
    
    .language-selector a {
      padding: 3px 8px;
      border-radius: 3px;
      text-decoration: none;
      font-size: 12px;
      background-color: rgba(64, 196, 199, 0.1);
      color: var(--primary-color);
    }
    
    .language-selector a:hover,
    .language-selector a.active {
      background-color: var(--primary-color);
      color: white;
    }
  </style>
</head>

<body>
  <div class="language-selector">
    <a href="<?= getScriptUrl() ?>?lang=es" class="<?= language === 'es' ? 'active' : '' ?>">ES</a>
    <a href="<?= getScriptUrl() ?>?lang=pt-BR" class="<?= language === 'pt-BR' ? 'active' : '' ?>">PT-BR</a>
  </div>
  
  <div class="container">
    <div class="logo">
      <!-- Intenta primero con la variable desde el servidor -->
      <img src="<?= logoUrl ?>" alt="Media Access Co." onerror="this.onerror=null; this.src='https://mediaaccesscompany.com/wp-content/uploads/2022/12/logo_banner_home.png';">
    </div>
    
    <div class="header">
      <div class="version-info">
        <span>v<?= getConfig().version ?> - Formato STL mejorado según especificación EBU Tech 3264</span>
      </div>
      <h1><?= getTranslation('app_title', language) ?></h1>
      <div class="help-link">
        <a href="<?= getScriptUrl() ?>?page=help&lang=<?= language ?>" id="helpLink" target="_blank"><?= getTranslation('help', language) ?></a>
      </div>
    </div>
    
    <div class="instructions">
      <h3><?= getTranslation('instructions_title', language) ?></h3>
      <ul>
        <li><?= getTranslation('instructions_item1', language) ?></li>
        <li><?= getTranslation('instructions_item2', language) ?></li>
        <li><?= getTranslation('instructions_item3', language) ?></li>
        <li><?= getTranslation('instructions_item4', language) ?></li>
        <li><?= getTranslation('instructions_item5', language) ?></li>
      </ul>
    </div>
    
    <div class="card info-card">
      <div class="card-header">
        <h4>Conversor Excel a STL</h4>
      </div>
      <div class="card-body">
        <p>Esta aplicación convierte archivos Excel con subtítulos al formato STL (EBU Subtitle Format) según la <a href="https://tech.ebu.ch/docs/tech/tech3264.pdf" target="_blank">especificación EBU Tech 3264</a>.</p>
        
        <p>Características actualizadas:</p>
        <ul>
          <li>Formato de GSI mejorado según la especificación EBU</li>
          <li>Mejor codificación de caracteres acentuados y especiales</li>
          <li>Posicionamiento vertical optimizado</li>
          <li>Soporte para inglés, español y portugués</li>
          <li><strong>¡NUEVO!</strong> Compatibilidad mejorada con editores de subtítulos profesionales</li>
          <li><strong>¡NUEVO!</strong> Soporte para etiquetas de color y formato de texto</li>
        </ul>
        
        <div class="alert alert-success mt-2">
          <strong>Actualización importante:</strong> Ahora los archivos STL generados son 100% compatibles con editores de subtítulos como EZTitles, FAB y WinCAPS.
        </div>
      </div>
    </div>
    
    <div id="uploadSection" class="upload-section">
      <p><?= getTranslation('drop_files', language) ?><br><?= getTranslation('or', language) ?></p>
      <button id="uploadBtn" class="upload-btn"><?= getTranslation('select_file', language) ?></button>
      <input type="file" id="fileInput" class="file-input" accept=".xls,.xlsx">
    </div>
    
    <div id="progressContainer" class="progress-container">
      <p id="progressText"><?= getTranslation('processing', language) ?></p>
      <div class="progress-bar">
        <div id="progress" class="progress"></div>
      </div>
    </div>
    
    <div id="status" class="status"></div>
    
    <button id="downloadBtn" class="download-btn"><?= getTranslation('download_btn', language) ?></button>
    
    <!-- Botón para limpiar archivos temporales -->
    <div style="text-align: center; margin-top: 15px;">
      <button id="cleanupBtn" class="cleanup-btn" style="display: none;"><?= getTranslation('cleanup_files', language) || 'Limpiar mis archivos temporales' ?></button>
    </div>
    
    <div class="format-info">
      <p><strong><?= getTranslation('format_info', language) ?></strong> <?= getTranslation('format_description', language) ?></p>
    </div>
    
    <div class="footer">
      <div class="footer-content">
        <!-- Intenta primero con la variable desde el servidor -->
        <img src="<?= logoUrl ?>" alt="Media Access Co." class="footer-logo" onerror="this.onerror=null; this.src='https://mediaaccesscompany.com/wp-content/uploads/2022/12/logo_banner_home.png';">
        
        <p><?= getTranslation('copyright', language, [new Date().getFullYear()]) ?></p>
        <p><?= getTranslation('more_details', language) ?> <a href="<?= getScriptUrl() ?>?page=help&lang=<?= language ?>" id="footerHelpLink" target="_blank"><?= getTranslation('help_page', language) ?></a></p>
        <p><a href="<?= getScriptUrl() ?>?page=diagnostic" id="diagnosticLink" target="_blank">Herramienta de Diagnóstico STL</a></p>
      </div>
    </div>
  </div>
  
  <script>
    // Variables para almacenar el resultado
    let downloadUrl = null;
    let fileName = null;
    
    // Idioma de la interfaz
    const currentLanguage = '<?= language ?>';
    
    // Corregir enlaces de ayuda cuando la página cargue
    document.addEventListener('DOMContentLoaded', function() {
      var baseUrl = window.location.href.split('?')[0];
      var helpLink = document.getElementById('helpLink');
      var footerHelpLink = document.getElementById('footerHelpLink');
      
      // Corregir enlaces si contienen errores
      if (helpLink && (helpLink.href.indexOf('undefined') !== -1 || helpLink.href.indexOf('#ERROR') !== -1)) {
        helpLink.href = baseUrl + '?page=help&lang=' + currentLanguage;
      }
      
      if (footerHelpLink && (footerHelpLink.href.indexOf('undefined') !== -1 || footerHelpLink.href.indexOf('#ERROR') !== -1)) {
        footerHelpLink.href = baseUrl + '?page=help&lang=' + currentLanguage;
      }
      
      // Asegurarnos de que el & no se codifique incorrectamente
      document.querySelectorAll('a[href*="page=help"]').forEach(function(link) {
        // Reconstruir la URL correctamente
        if (link.href.indexOf('?') !== -1) {
          var baseUrl = link.href.split('?')[0];
          var params = new URLSearchParams();
          params.set('page', 'help');
          params.set('lang', currentLanguage);
          link.href = baseUrl + '?' + params.toString();
        }
      });
    });
    
    // Traducciones de respaldo (directamente en el cliente)
    const fallbackTranslations = {
      'es': {
        'app_title': 'Conversor Excel a STL',
        'conversion_complete': 'Conversión completada',
        'success_message': 'El archivo fue convertido exitosamente a formato STL.',
        'download_btn': 'Descargar archivo STL',
        'error_format': 'Por favor, seleccione un archivo Excel válido (.xls o .xlsx).',
        'error_read': 'Error al leer el archivo: ',
        'warning_excel': 'ADVERTENCIA: El archivo Excel no pudo ser interpretado correctamente. Se ha generado un archivo STL con un mensaje de error.',
        'notice_sample': 'AVISO: Debido a limitaciones técnicas, se ha generado un archivo STL de muestra. Este archivo contiene únicamente subtítulos de ejemplo.',
        'no_file': 'No hay archivo STL disponible para descargar.',
        'download_started': 'Descarga iniciada. Puede cargar un nuevo archivo cuando desee.',
        'cleanup_files': 'Limpiar mis archivos temporales',
        'confirm_cleanup': '¿Estás seguro de que deseas eliminar tus archivos temporales?',
        'convert_stl': 'Convirtiendo a STL...',
        'error_unexpected': 'Error inesperado durante la conversión.',
        'select_file': 'Seleccionar archivo',
        'processing': 'Procesando...'
      },
      'pt-BR': {
        'app_title': 'Conversor Excel para STL',
        'conversion_complete': 'Conversão concluída',
        'success_message': 'O arquivo foi convertido com sucesso para o formato STL.',
        'download_btn': 'Baixar arquivo STL',
        'error_format': 'Por favor, selecione um arquivo Excel válido (.xls ou .xlsx).',
        'error_read': 'Erro ao ler o arquivo: ',
        'warning_excel': 'AVISO: O arquivo Excel não pôde ser interpretado corretamente. Foi gerado um arquivo STL com uma mensagem de erro.',
        'notice_sample': 'AVISO: Devido a limitações técnicas, foi gerado um arquivo STL de amostra. Este arquivo contém apenas legendas de exemplo.',
        'no_file': 'Não há arquivo STL disponível para download.',
        'download_started': 'Download iniciado. Você pode carregar um novo arquivo quando quiser.',
        'cleanup_files': 'Limpar meus arquivos temporários',
        'confirm_cleanup': 'Tem certeza de que deseja excluir seus arquivos temporários?',
        'convert_stl': 'Convertendo para STL...',
        'error_unexpected': 'Erro inesperado durante a conversão.',
        'select_file': 'Selecionar arquivo',
        'processing': 'Processando...'
      }
    };
    
    // Obtener todas las traducciones para el idioma actual 
    let translations;
    try {
      translations = JSON.parse('<?= json_encode(getAllTranslations($language)) ?>');
      // Verificar si el objeto recibido es válido
      if (!translations || typeof translations !== 'object' || Object.keys(translations).length === 0) {
        throw new Error('Traducciones inválidas del servidor');
      }
      console.log('Traducciones cargadas del servidor:', Object.keys(translations).length, 'claves');
    } catch (error) {
      console.error('Error al cargar traducciones del servidor:', error);
      // Usar traducciones de respaldo
      translations = fallbackTranslations[currentLanguage] || fallbackTranslations['es'];
      console.log('Usando traducciones de respaldo');
    }
    
    // Función para traducir texto simplificada y robusta
    function t(key, ...params) {
      // Buscar el texto en las traducciones o usar respaldo
      let text;
      
      if (translations && translations[key]) {
        text = translations[key];
      } else if (fallbackTranslations[currentLanguage] && fallbackTranslations[currentLanguage][key]) {
        text = fallbackTranslations[currentLanguage][key];
      } else if (fallbackTranslations['es'] && fallbackTranslations['es'][key]) {
        text = fallbackTranslations['es'][key];
      } else {
        console.warn('Advertencia: No hay traducción para la clave "' + key + '"');
        return key; // Si todo falla, devolver la clave
      }
      
      // Reemplazar parámetros si existen
      if (params && params.length > 0) {
        for (let i = 0; i < params.length; i++) {
          text = text.replace('{' + i + '}', params[i]);
        }
      }
      
      return text;
    }
    
    // Actualizar textos iniciales fijos cuando DOMContentLoaded
    document.addEventListener('DOMContentLoaded', function() {
      if (progressText) {
        progressText.textContent = t('processing');
      }
      if (uploadBtn) {
        uploadBtn.textContent = t('select_file');
        console.log('Texto del botón actualizado a:', t('select_file'));
      }
      if (downloadBtn) {
        downloadBtn.textContent = t('download_btn');
      }
    });
    
    // Elementos del DOM
    const uploadSection = document.getElementById('uploadSection');
    const uploadBtn = document.getElementById('uploadBtn');
    const fileInput = document.getElementById('fileInput');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progress');
    const progressText = document.getElementById('progressText');
    const statusDiv = document.getElementById('status');
    const downloadBtn = document.getElementById('downloadBtn');
    
    // Función para verificar si las imágenes del logo cargaron correctamente
    window.addEventListener('load', function() {
      // Usar la URL del logo proporcionada por el usuario
      const backupLogoUrl = "https://mediaaccesscompany.com/wp-content/uploads/2022/12/logo_banner_home.png";
      
      const logos = document.querySelectorAll('img[alt="Media Access Co."]');
      logos.forEach(logo => {
        if (!logo.complete || logo.naturalHeight === 0) {
          logo.src = backupLogoUrl;
        }
      });
    });
    
    // Click en el botón de carga abre el selector de archivos
    uploadBtn.addEventListener('click', () => {
      fileInput.click();
    });
    
    // Manejo de la selección de archivo
    fileInput.addEventListener('change', handleFileSelect);
    
    // Configuración de drag and drop
    uploadSection.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.stopPropagation();
      uploadSection.classList.add('drag-over');
    });
    
    uploadSection.addEventListener('dragleave', (e) => {
      e.preventDefault();
      e.stopPropagation();
      uploadSection.classList.remove('drag-over');
    });
    
    uploadSection.addEventListener('drop', (e) => {
      e.preventDefault();
      e.stopPropagation();
      uploadSection.classList.remove('drag-over');
      
      const dt = e.dataTransfer;
      const files = dt.files;
      
      if (files.length) {
        fileInput.files = files;
        handleFileSelect();
      }
    });
    
    // Manejo de la descarga del archivo STL
    downloadBtn.addEventListener('click', function() {
      if (!downloadUrl) {
        showStatus(t('no_file'), 'error');
        return;
      }
      
      // Abrir la URL de descarga en una nueva pestaña
      window.open(downloadUrl, '_blank');
      
      // Después de la descarga, resetear la aplicación
      setTimeout(function() {
        resetApplication();
      }, 2000); // Esperar 2 segundos para asegurar que se inició la descarga
    });
    
    // Función para resetear la aplicación
    function resetApplication() {
      // Ocultar la barra de progreso y botón de descarga
      progressContainer.style.display = 'none';
      downloadBtn.style.display = 'none';
      
      // Resetear valores
      progressBar.style.width = '0%';
      downloadUrl = null;
      fileName = null;
      
      // Limpiar el input de archivo
      fileInput.value = null;
      
      // Mostrar un mensaje de éxito que indique que se puede cargar un nuevo archivo
      showStatus(t('download_started'), 'success');
    }
    
    // Función para manejar la selección de archivos
    function handleFileSelect() {
      const file = fileInput.files[0];
      
      if (!file) {
        return;
      }
      
      // Verificar extensión del archivo
      const fileName = file.name.toLowerCase();
      if (!fileName.endsWith('.xls') && !fileName.endsWith('.xlsx')) {
        showStatus(t('error_format'), 'error');
        return;
      }
      
      // Mostrar progreso
      progressContainer.style.display = 'block';
      progressBar.style.width = '10%';
      statusDiv.style.display = 'none';
      downloadBtn.style.display = 'none';
      
      // Leer el archivo como Base64
      const reader = new FileReader();
      reader.onload = function(e) {
        progressBar.style.width = '40%';
        // Obtener el contenido como Base64 y quitar el prefijo
        const base64Content = e.target.result.split(',')[1];
        
        // Enviar al servidor como Base64 junto con el nombre del archivo
        uploadToServer(base64Content, file.name);
      };
      reader.onerror = function(e) {
        showStatus(t('error_read') + e.target.error, 'error');
      };
      reader.readAsDataURL(file); // Leer como URL de datos (Base64)
    }
    
    // Función para subir al servidor
    function uploadToServer(base64Content, fileName) {
      progressText.textContent = t('convert_stl');
      progressBar.style.width = '70%';
      
      // Mostrar el botón de limpieza
      document.getElementById('cleanupBtn').style.display = 'inline-block';
      
      // Llamar a la función de Apps Script con datos Base64
      google.script.run
        .withSuccessHandler(function(result) {
          progressBar.style.width = '100%';
          
          // Asegurar que el texto esté correctamente traducido - usar la función t para traducción segura
          progressText.textContent = t('conversion_complete');
          
          // Verificar si el resultado es un objeto con información completa
          if (typeof result === 'object' && result.success === true) {
            // Guardamos los datos relevantes
            window.downloadUrl = result.downloadUrl;
            window.fileName = result.fileName;
            
            // Mostramos mensaje de éxito
            showStatus(t('success_message'), 'success');
            downloadBtn.style.display = 'block';
            
            // Configurar el botón de descarga con el nombre del archivo
            downloadBtn.textContent = t('download_btn');
            
            // Actualizar el funcionamiento del botón de descarga
            downloadBtn.onclick = function() {
              window.open(window.downloadUrl, '_blank');
            };
          } else if (typeof result === 'string') {
            // Para mantener retrocompatibilidad con versiones anteriores
            if (result.includes('#error')) {
              // Caso de error al leer el archivo
              let cleanUrl = result.replace('#error', '');
              window.downloadUrl = cleanUrl;
              
              showStatus(t('warning_excel'), 'error');
              downloadBtn.style.display = 'block';
              downloadBtn.textContent = t('download_btn');
              
              downloadBtn.onclick = function() {
                window.open(cleanUrl, '_blank');
              };
            } else if (result.includes('#sample')) {
              // Caso de archivo de muestra (fallback)
              let cleanUrl = result.replace('#sample', '');
              window.downloadUrl = cleanUrl;
              
              showStatus(t('notice_sample'), 'error');
              downloadBtn.style.display = 'block';
              downloadBtn.textContent = t('download_btn');
              
              downloadBtn.onclick = function() {
                window.open(cleanUrl, '_blank');
              };
            } else {
              // Procesamiento normal sin errores (versión antigua)
              window.downloadUrl = result;
              showStatus(t('success_message'), 'success');
              downloadBtn.style.display = 'block';
              downloadBtn.textContent = t('download_btn');
              
              downloadBtn.onclick = function() {
                window.open(result, '_blank');
              };
            }
          } else {
            // En caso de un resultado no esperado
            showStatus(t('error_unexpected') || 'Error inesperado', 'error');
          }
        })
        .withFailureHandler(processError)
        .processExcelBase64(base64Content, fileName);
    }
    
    // Manejo error
    function processError(error) {
      progressBar.style.width = '0%';
      progressContainer.style.display = 'none';
      showStatus('Error: ' + error.message, 'error');
    }
    
    // Mostrar mensaje de estado
    function showStatus(message, type) {
      statusDiv.innerText = message;
      statusDiv.className = 'status ' + type;
      statusDiv.style.display = 'block';
    }
    
    // Configurar el botón de limpieza de archivos temporales
    document.getElementById('cleanupBtn').addEventListener('click', function() {
      // Crear un mensaje más informativo para la confirmación
      const confirmMessage = currentLanguage === 'pt-BR' 
        ? 'Tem certeza de que deseja excluir seus arquivos temporários? Esta ação não pode ser desfeita e removerá todos os arquivos STL temporários criados por você.'
        : '¿Estás seguro de que deseas eliminar tus archivos temporales? Esta acción no se puede deshacer y eliminará todos los archivos STL temporales creados por ti.';
      
      if (confirm(confirmMessage)) {
        // Mostrar un mensaje de espera mientras se procesan los archivos
        const waitMessage = currentLanguage === 'pt-BR'
          ? 'Limpando arquivos temporários...'
          : 'Limpiando archivos temporales...';
        
        showStatus(waitMessage, 'success');
        
        google.script.run
          .withSuccessHandler(function(result) {
            // Mejorar el mensaje de éxito con el número de archivos eliminados
            const successPrefix = currentLanguage === 'pt-BR'
              ? 'Limpieza completada: '
              : 'Limpieza completada: ';
            
            showStatus(successPrefix + result, 'success');
          })
          .withFailureHandler(function(error) {
            const errorPrefix = currentLanguage === 'pt-BR'
              ? 'Erro ao limpar arquivos: '
              : 'Error al limpiar archivos: ';
            
            showStatus(errorPrefix + error.message, 'error');
          })
          .cleanupMyTempFiles();
      }
    });
  </script>
</body>
</html> 